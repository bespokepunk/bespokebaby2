<!DOCTYPE html>
<html>
<head>
    <title>Bulletproof Caption Review</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Monaco', monospace; background: #0a0a0a; color: #e0e0e0; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; }

        .header { text-align: center; margin-bottom: 15px; padding: 15px; background: #1a1a1a; border-radius: 8px; }
        h1 { color: #00ff88; font-size: 24px; }
        .subtitle { color: #888; font-size: 12px; margin-top: 5px; }
        .import-section { margin-top: 15px; }
        .import-btn { padding: 12px 25px; background: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin: 5px; }
        .import-btn:hover { background: #ff5252; }
        .download-btn { padding: 12px 25px; background: #4a9eff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin: 5px; }
        .download-btn:hover { background: #3a8eef; }
        input[type="file"] { display: none; }

        .progress { background: #1a1a1a; padding: 12px; border-radius: 8px; margin-bottom: 15px; }
        .progress-bar { width: 100%; height: 20px; background: #0a0a0a; border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #00ff88, #00cc66); transition: width 0.3s; }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
        .stat { background: #0a0a0a; padding: 8px; border-radius: 4px; text-align: center; }
        .stat-num { font-size: 18px; color: #00ff88; font-weight: bold; }
        .stat-label { font-size: 9px; color: #666; margin-top: 3px; }

        .main { display: grid; grid-template-columns: 450px 1fr; gap: 15px; }

        .image-panel { background: #1a1a1a; padding: 15px; border-radius: 8px; }
        .punk-img { width: 420px; height: 420px; image-rendering: pixelated; border: 3px solid #333; }
        .filename { margin-top: 10px; color: #00ff88; font-weight: bold; text-align: center; font-size: 13px; }

        .shortcuts { margin-top: 15px; background: #0a0a0a; padding: 12px; border-radius: 4px; }
        .shortcuts-title { color: #00ff88; font-size: 11px; font-weight: bold; margin-bottom: 8px; }
        .shortcut { font-size: 10px; color: #888; margin: 4px 0; }
        .key { color: #00ff88; font-weight: bold; }

        .review-panel { background: #1a1a1a; padding: 15px; border-radius: 8px; }

        .caption-row { display: grid; grid-template-columns: 80px 1fr; gap: 10px; margin-bottom: 10px; }
        .caption-label { color: #00ff88; font-size: 11px; font-weight: bold; padding-top: 5px; }
        .caption-text { background: #0a0a0a; padding: 10px; border-radius: 4px; font-size: 11px; line-height: 1.5; color: #888; border: 2px solid #2a2a2a; }
        .ai-caption { color: #51cf66; }

        .input-box { width: 100%; min-height: 100px; background: #0a0a0a; border: 3px solid #2a2a2a; color: #e0e0e0; padding: 12px; font-size: 13px; border-radius: 4px; font-family: inherit; resize: vertical; }
        .input-box:focus { border-color: #00ff88; outline: none; }

        .action-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px; }
        button { padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; font-family: inherit; transition: all 0.2s; }
        .btn-prev { background: #2a2a2a; color: #e0e0e0; }
        .btn-prev:hover { background: #3a3a3a; }
        .btn-approve { background: #00ff88; color: #000; }
        .btn-approve:hover { background: #00cc66; }
        .btn-save { background: #4a9eff; color: #fff; }
        .btn-save:hover { background: #3a8eef; }
        .btn-skip { background: #444; color: #e0e0e0; }
        .btn-skip:hover { background: #555; }

        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #00ff88;
            color: #000;
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 1000;
        }
        .save-indicator.show { opacity: 1; }

        .warning { background: #ff6b6b; color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-weight: bold; text-align: center; }
    </style>
</head>
<body>
    <div class="save-indicator" id="save-indicator">‚úì Saved!</div>
    <div class="container">
        <div class="header">
            <h1>üîí Bulletproof Caption Review</h1>
            <p class="subtitle">Auto-downloads backup every 5 saves - NEVER lose progress</p>
            <div class="import-section">
                <button class="import-btn" onclick="document.getElementById('fileInput').click()">üìÇ IMPORT BACKUP FILE</button>
                <button class="download-btn" onclick="downloadNow()">üíæ DOWNLOAD BACKUP NOW</button>
                <input type="file" id="fileInput" accept=".json" onchange="importBackup(event)">
            </div>
        </div>

        <div id="warning" class="warning" style="display: none;"></div>

        <div class="progress">
            <div><strong id="current">1</strong> / <strong id="total">203</strong> ¬∑ <span id="percent">0%</span> complete</div>
            <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
            <div class="stats">
                <div class="stat"><div class="stat-num" id="approved">0</div><div class="stat-label">Approved</div></div>
                <div class="stat"><div class="stat-num" id="edited">0</div><div class="stat-label">Edited</div></div>
                <div class="stat"><div class="stat-num" id="skipped">0</div><div class="stat-label">Skipped</div></div>
                <div class="stat"><div class="stat-num" id="remaining">203</div><div class="stat-label">Remaining</div></div>
            </div>
        </div>

        <div class="main">
            <div class="image-panel">
                <img id="punk-img" class="punk-img" src="" alt="Punk">
                <div class="filename" id="filename"></div>

                <div class="shortcuts">
                    <div class="shortcuts-title">‚ö° Keyboard Shortcuts</div>
                    <div class="shortcut"><span class="key">A</span> - Approve AI caption</div>
                    <div class="shortcut"><span class="key">E</span> - Save edit</div>
                    <div class="shortcut"><span class="key">S</span> - Skip</div>
                    <div class="shortcut"><span class="key">‚Üê</span> - Go back</div>
                </div>
            </div>

            <div class="review-panel">
                <div class="caption-row">
                    <div class="caption-label">CURRENT:</div>
                    <div class="caption-text" id="current-caption"></div>
                </div>

                <div class="caption-row">
                    <div class="caption-label ai-caption">AI NEW:</div>
                    <div class="caption-text ai-caption" id="ai-caption"></div>
                </div>

                <div style="margin-top: 15px;">
                    <label style="color: #00ff88; font-size: 12px; font-weight: bold; display: block; margin-bottom: 8px;">Your Corrections:</label>
                    <textarea id="user-input" class="input-box" placeholder="Type corrections, or press A to approve, or S to skip..."></textarea>
                </div>

                <div class="action-buttons">
                    <button class="btn-prev" onclick="prev()">‚Üê Back</button>
                    <button class="btn-approve" onclick="approve()">‚úì Approve (A)</button>
                    <button class="btn-save" onclick="saveEdit()">Save Edit (E)</button>
                    <button class="btn-skip" onclick="skip()">Skip (S)</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let data = [];
        let currentIndex = 0;
        let results = { approved: [], edited: [], skipped: [] };
        let saveCounter = 0;

        // FORCE FRESH START - clear old localStorage and start reversed
        localStorage.removeItem('bulletproof_backup');
        console.log('üîÑ Starting fresh in REVERSE order');
        loadFreshData();

        function loadFreshData() {
            fetch('comprehensive_captions_for_review.json')
                .then(r => r.json())
                .then(d => {
                    data = d.reverse(); // REVERSE ORDER - start from end
                    console.log('‚úì Loaded data in REVERSE order');
                    loadPunk(0);
                })
                .catch(err => alert('Error loading data: ' + err.message));
        }

        function loadPunk(index) {
            if (index < 0 || index >= data.length) return;

            currentIndex = index;
            const punk = data[index];

            document.getElementById('punk-img').src = 'civitai_v2_7_training/' + punk.filename;
            document.getElementById('filename').textContent = punk.filename;
            document.getElementById('current-caption').textContent = punk.currentCaption || 'None';
            document.getElementById('ai-caption').textContent = punk.aiComprehensiveCaption || 'None';
            document.getElementById('user-input').value = punk.userInput || '';

            updateProgress();
        }

        function saveToLocalStorage() {
            const backup = {
                data: data,
                results: results,
                currentIndex: currentIndex,
                saveCounter: saveCounter,
                timestamp: new Date().toISOString()
            };
            try {
                localStorage.setItem('bulletproof_backup', JSON.stringify(backup));
                console.log('üíæ Saved to localStorage');
            } catch(e) {
                console.error('localStorage save error:', e);
            }
        }

        function approve() {
            const punk = data[currentIndex];
            punk.userApproved = true;
            punk.finalCaption = punk.aiComprehensiveCaption;
            punk.timestamp = new Date().toISOString();
            results.approved.push(punk);

            saveToLocalStorage();
            showSaveIndicator('approved');
            checkAutoDownload();
            next();
        }

        function saveEdit() {
            const punk = data[currentIndex];
            const edited = document.getElementById('user-input').value.trim();

            if (!edited) {
                alert('Type a correction first, or press A to approve!');
                return;
            }

            punk.userInput = edited;
            punk.userApproved = true;
            punk.timestamp = new Date().toISOString();
            results.edited.push(punk);

            saveToLocalStorage();
            showSaveIndicator('edited');
            checkAutoDownload();
            next();
        }

        function skip() {
            results.skipped.push(data[currentIndex]);
            saveToLocalStorage();
            showSaveIndicator('skipped');
            next();
        }

        function prev() {
            if (currentIndex > 0) {
                // Save current input before going back
                if (currentIndex < data.length) {
                    data[currentIndex].userInput = document.getElementById('user-input').value.trim();
                }
                saveToLocalStorage();
                loadPunk(currentIndex - 1);
            }
        }

        function next() {
            if (currentIndex < data.length - 1) {
                loadPunk(currentIndex + 1);
            } else {
                alert('üéâ ALL DONE! Downloading final results...');
                downloadNow();
            }
        }

        function checkAutoDownload() {
            saveCounter++;
            const total = results.approved.length + results.edited.length;

            // Auto-download every 5 saves
            if (saveCounter % 5 === 0) {
                downloadNow();
                showWarning(`‚úì AUTO-BACKUP downloaded! (${total} entries saved)`);
            }
        }

        function showSaveIndicator(action) {
            const total = results.approved.length + results.edited.length + results.skipped.length;
            const indicator = document.getElementById('save-indicator');
            indicator.textContent = `‚úì ${action} (${total} total)`;
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 1000);
        }

        function showWarning(msg) {
            const warning = document.getElementById('warning');
            warning.textContent = msg;
            warning.style.display = 'block';
            setTimeout(() => warning.style.display = 'none', 3000);
        }

        function updateProgress() {
            const total = results.approved.length + results.edited.length + results.skipped.length;
            const remaining = data.length - total;
            const percent = (total / data.length) * 100;

            document.getElementById('progress').style.width = percent + '%';
            document.getElementById('current').textContent = currentIndex + 1;
            document.getElementById('total').textContent = data.length;
            document.getElementById('percent').textContent = Math.round(percent);
            document.getElementById('approved').textContent = results.approved.length;
            document.getElementById('edited').textContent = results.edited.length;
            document.getElementById('skipped').textContent = results.skipped.length;
            document.getElementById('remaining').textContent = remaining;
        }

        function downloadNow() {
            const output = {
                data: data,
                results: results,
                currentIndex: currentIndex,
                timestamp: new Date().toISOString(),
                summary: {
                    total: data.length,
                    approved: results.approved.length,
                    edited: results.edited.length,
                    skipped: results.skipped.length,
                    completed: results.approved.length + results.edited.length
                }
            };

            const blob = new Blob([JSON.stringify(output, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CAPTION_REVIEW_BACKUP_${Date.now()}.json`;
            a.click();

            console.log('üì• Downloaded backup:', output.summary);
        }

        function importBackup(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);

                    // Restore everything
                    data = backup.data;
                    results = backup.results;
                    currentIndex = backup.currentIndex || 0;

                    loadPunk(currentIndex);

                    const total = results.approved.length + results.edited.length;
                    alert(`‚úì RESTORED from backup!\n\n${total} entries recovered\nContinuing from punk #${currentIndex + 1}`);
                } catch(err) {
                    alert('Error importing backup: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        // Auto-save input as user types
        let typingTimeout;
        document.getElementById('user-input').addEventListener('input', () => {
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                if (currentIndex >= 0 && currentIndex < data.length) {
                    data[currentIndex].userInput = document.getElementById('user-input').value.trim();
                    saveToLocalStorage();
                }
            }, 500);
        });

        // Save before page unload
        window.addEventListener('beforeunload', () => {
            if (currentIndex >= 0 && currentIndex < data.length) {
                data[currentIndex].userInput = document.getElementById('user-input').value.trim();
                saveToLocalStorage();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'TEXTAREA') return;

            if (e.key === 'a' || e.key === 'A') approve();
            if (e.key === 'e' || e.key === 'E') saveEdit();
            if (e.key === 's' || e.key === 'S') skip();
            if (e.key === 'ArrowLeft') prev();
        });
    </script>
</body>
</html>
