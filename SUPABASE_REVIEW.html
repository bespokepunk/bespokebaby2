<!DOCTYPE html>
<html>
<head>
    <title>‚òÅÔ∏è Cloud Caption Review - Supabase</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Monaco', monospace; background: #0a0a0a; color: #e0e0e0; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; }

        .header { text-align: center; margin-bottom: 15px; padding: 15px; background: #1a1a1a; border-radius: 8px; }
        h1 { color: #00ff88; font-size: 24px; }
        .subtitle { color: #888; font-size: 12px; margin-top: 5px; }
        .cloud-status { margin-top: 10px; padding: 10px; background: #0a0a0a; border-radius: 4px; }
        .status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .connected { background: #00ff88; }
        .disconnected { background: #ff6b6b; }
        .syncing { background: #ffd93d; }

        .progress { background: #1a1a1a; padding: 12px; border-radius: 8px; margin-bottom: 15px; }
        .progress-bar { width: 100%; height: 20px; background: #0a0a0a; border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #00ff88, #00cc66); transition: width 0.3s; }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
        .stat { background: #0a0a0a; padding: 8px; border-radius: 4px; text-align: center; }
        .stat-num { font-size: 18px; color: #00ff88; font-weight: bold; }
        .stat-label { font-size: 9px; color: #666; margin-top: 3px; }

        .main { display: grid; grid-template-columns: 450px 1fr; gap: 15px; }

        .image-panel { background: #1a1a1a; padding: 15px; border-radius: 8px; }
        .punk-img { width: 420px; height: 420px; image-rendering: pixelated; border: 3px solid #333; }
        .filename { margin-top: 10px; color: #00ff88; font-weight: bold; text-align: center; font-size: 13px; }

        .shortcuts { margin-top: 15px; background: #0a0a0a; padding: 12px; border-radius: 4px; }
        .shortcuts-title { color: #00ff88; font-size: 11px; font-weight: bold; margin-bottom: 8px; }
        .shortcut { font-size: 10px; color: #888; margin: 4px 0; }
        .key { color: #00ff88; font-weight: bold; }

        .review-panel { background: #1a1a1a; padding: 15px; border-radius: 8px; }

        .caption-row { display: grid; grid-template-columns: 80px 1fr; gap: 10px; margin-bottom: 10px; }
        .caption-label { color: #00ff88; font-size: 11px; font-weight: bold; padding-top: 5px; }
        .caption-text { background: #0a0a0a; padding: 10px; border-radius: 4px; font-size: 11px; line-height: 1.5; color: #888; border: 2px solid #2a2a2a; }
        .ai-caption { color: #51cf66; }

        .input-box { width: 100%; min-height: 100px; background: #0a0a0a; border: 3px solid #2a2a2a; color: #e0e0e0; padding: 12px; font-size: 13px; border-radius: 4px; font-family: inherit; resize: vertical; }
        .input-box:focus { border-color: #00ff88; outline: none; }

        .action-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px; }
        button { padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; font-family: inherit; transition: all 0.2s; }
        .btn-prev { background: #2a2a2a; color: #e0e0e0; }
        .btn-prev:hover { background: #3a3a3a; }
        .btn-approve { background: #00ff88; color: #000; }
        .btn-approve:hover { background: #00cc66; }
        .btn-save { background: #4a9eff; color: #fff; }
        .btn-save:hover { background: #3a8eef; }
        .btn-skip { background: #444; color: #e0e0e0; }
        .btn-skip:hover { background: #555; }

        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #00ff88;
            color: #000;
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 1000;
        }
        .save-indicator.show { opacity: 1; }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1a1a1a;
            padding: 40px;
            border-radius: 8px;
            border: 2px solid #00ff88;
            z-index: 2000;
            text-align: center;
        }
        .spinner {
            border: 4px solid #2a2a2a;
            border-top: 4px solid #00ff88;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <div>Connecting to cloud database...</div>
    </div>

    <div class="save-indicator" id="save-indicator">‚úì Saved!</div>
    <div class="container" style="display: none;" id="main-content">
        <div class="header">
            <h1>‚òÅÔ∏è Cloud Caption Review</h1>
            <p class="subtitle">Every save goes to Supabase - NEVER lose progress</p>
            <div class="cloud-status">
                <span class="status-dot" id="status-dot"></span>
                <span id="status-text">Connecting...</span>
            </div>
        </div>

        <div class="progress">
            <div><strong id="current">1</strong> / <strong id="total">203</strong> ¬∑ <span id="percent">0%</span> complete</div>
            <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
            <div class="stats">
                <div class="stat"><div class="stat-num" id="approved">0</div><div class="stat-label">Approved</div></div>
                <div class="stat"><div class="stat-num" id="edited">0</div><div class="stat-label">Edited</div></div>
                <div class="stat"><div class="stat-num" id="skipped">0</div><div class="stat-label">Skipped</div></div>
                <div class="stat"><div class="stat-num" id="remaining">203</div><div class="stat-label">Remaining</div></div>
            </div>
        </div>

        <div class="main">
            <div class="image-panel">
                <img id="punk-img" class="punk-img" src="" alt="Punk">
                <div class="filename" id="filename"></div>

                <div class="shortcuts">
                    <div class="shortcuts-title">‚ö° Keyboard Shortcuts</div>
                    <div class="shortcut"><span class="key">A</span> - Approve AI caption</div>
                    <div class="shortcut"><span class="key">E</span> - Save edit</div>
                    <div class="shortcut"><span class="key">S</span> - Skip</div>
                    <div class="shortcut"><span class="key">‚Üê</span> - Go back</div>
                </div>
            </div>

            <div class="review-panel">
                <div class="caption-row">
                    <div class="caption-label">CURRENT:</div>
                    <div class="caption-text" id="current-caption"></div>
                </div>

                <div class="caption-row">
                    <div class="caption-label ai-caption">AI NEW:</div>
                    <div class="caption-text ai-caption" id="ai-caption"></div>
                </div>

                <div style="margin-top: 15px;">
                    <label style="color: #00ff88; font-size: 12px; font-weight: bold; display: block; margin-bottom: 8px;">Your Corrections:</label>
                    <textarea id="user-input" class="input-box" placeholder="Type corrections, or press A to approve, or S to skip..."></textarea>
                </div>

                <div class="action-buttons">
                    <button class="btn-prev" onclick="prev()">‚Üê Back</button>
                    <button class="btn-approve" onclick="approve()">‚úì Approve (A)</button>
                    <button class="btn-save" onclick="saveEdit()">Save Edit (E)</button>
                    <button class="btn-skip" onclick="skip()">Skip (S)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://qwvncbcphuyobijakdsr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3dm5jYmNwaHV5b2JpamFrZHNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MTA4NDgsImV4cCI6MjA3ODI4Njg0OH0.cE00n2favc7IK7fOwzCyDfTJK0tMntftb9gi_xfjpQ4';

        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let data = [];
        let currentIndex = 0;
        let stats = { approved: 0, edited: 0, skipped: 0, pending: 0 };

        // Initialize
        async function init() {
            try {
                setStatus('syncing', 'Loading from database...');

                // Load comprehensive data from JSON
                const response = await fetch('comprehensive_captions_for_review.json');
                const jsonData = await response.json();

                // Reverse the order to start from the end
                data = jsonData.reverse();

                // Initialize database with all punks
                await initializeDatabase();

                // Load progress from database
                await loadProgress();

                setStatus('connected', 'Connected to cloud');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';

                loadPunk(currentIndex);
            } catch (error) {
                console.error('Init error:', error);
                setStatus('disconnected', 'Connection failed: ' + error.message);
                alert('Failed to connect to database: ' + error.message);
            }
        }

        async function initializeDatabase() {
            console.log('Initializing database with', data.length, 'punks...');

            // Check if database already has data
            const { count, error: countError } = await supabase
                .from('caption_reviews')
                .select('*', { count: 'exact', head: true });

            if (countError) {
                console.error('Error checking database:', countError);
                throw new Error('Database check failed: ' + countError.message);
            }

            if (count > 0) {
                console.log('‚úì Database already has', count, 'entries');
                return;
            }

            // Batch insert all punks at once
            const records = data.map(punk => ({
                filename: punk.filename,
                current_caption: punk.currentCaption || '',
                ai_comprehensive_caption: punk.aiComprehensiveCaption || '',
                user_input: '',
                user_corrections: '',
                status: 'pending',
                final_caption: '',
                full_palette_15: punk.fullPalette15 || [],
                region_analysis: punk.regionAnalysis || {},
                detected_traits: punk.detectedTraits || {},
                full_data: punk
            }));

            // Insert in batches of 50 to avoid timeouts
            const batchSize = 50;
            for (let i = 0; i < records.length; i += batchSize) {
                const batch = records.slice(i, i + batchSize);
                console.log(`Inserting batch ${i / batchSize + 1}/${Math.ceil(records.length / batchSize)}...`);

                const { error } = await supabase
                    .from('caption_reviews')
                    .insert(batch);

                if (error) {
                    console.error('Batch insert error:', error);
                    throw new Error('Failed to initialize database: ' + error.message);
                }
            }

            console.log('‚úì Database initialized with', records.length, 'punks');
        }

        async function loadProgress() {
            // Get all reviews from database
            const { data: reviews, error } = await supabase
                .from('caption_reviews')
                .select('*')
                .order('updated_at', { ascending: false });

            if (error) {
                console.error('Error loading progress:', error);
                return;
            }

            // Merge database data with local data
            reviews.forEach(review => {
                const punk = data.find(p => p.filename === review.filename);
                if (punk) {
                    punk.userInput = review.user_input || '';
                    punk.status = review.status || 'pending';
                    punk.userApproved = review.status === 'approved' || review.status === 'edited';
                }
            });

            // Calculate stats
            stats = {
                approved: reviews.filter(r => r.status === 'approved').length,
                edited: reviews.filter(r => r.status === 'edited').length,
                skipped: reviews.filter(r => r.status === 'skipped').length,
                pending: reviews.filter(r => r.status === 'pending').length
            };

            // Find first pending punk
            const firstPending = data.findIndex(p => p.status === 'pending' || !p.status);
            if (firstPending >= 0) {
                currentIndex = firstPending;
            }

            console.log('‚úì Progress loaded:', stats);
        }

        function setStatus(status, text) {
            const dot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');

            dot.className = 'status-dot ' + status;
            statusText.textContent = text;
        }

        function loadPunk(index) {
            if (index < 0 || index >= data.length) return;

            currentIndex = index;
            const punk = data[index];

            document.getElementById('punk-img').src = 'civitai_v2_7_training/' + punk.filename;
            document.getElementById('filename').textContent = punk.filename;
            document.getElementById('current-caption').textContent = punk.currentCaption || 'None';
            document.getElementById('ai-caption').textContent = punk.aiComprehensiveCaption || 'None';
            document.getElementById('user-input').value = punk.userInput || '';

            updateProgress();
        }

        async function approve() {
            const punk = data[currentIndex];

            setStatus('syncing', 'Saving to cloud...');

            // Final caption is the AI comprehensive caption (approved as-is)
            const finalCaption = punk.aiComprehensiveCaption;

            const { error } = await supabase
                .from('caption_reviews')
                .update({
                    status: 'approved',
                    user_input: '',
                    user_corrections: '',
                    final_caption: finalCaption,
                    full_palette_15: punk.fullPalette15,
                    region_analysis: punk.regionAnalysis,
                    detected_traits: punk.detectedTraits,
                    updated_at: new Date().toISOString()
                })
                .eq('filename', punk.filename);

            if (error) {
                console.error('Save error:', error);
                alert('Failed to save: ' + error.message);
                setStatus('disconnected', 'Save failed');
                return;
            }

            punk.status = 'approved';
            punk.userApproved = true;
            punk.finalCaption = finalCaption;
            stats.approved++;
            stats.pending--;

            setStatus('connected', 'Connected to cloud');
            showSaveIndicator('‚òÅÔ∏è Approved & synced');
            next();
        }

        async function saveEdit() {
            const punk = data[currentIndex];
            const userCorrections = document.getElementById('user-input').value.trim();

            if (!userCorrections) {
                alert('Type a correction first, or press A to approve!');
                return;
            }

            setStatus('syncing', 'Saving to cloud...');

            // Merge AI caption with user corrections to create final caption
            // User corrections are appended or override specific traits
            const finalCaption = mergeCaptions(punk.aiComprehensiveCaption, userCorrections, punk);

            const { error } = await supabase
                .from('caption_reviews')
                .update({
                    status: 'edited',
                    user_input: userCorrections,
                    user_corrections: userCorrections,
                    final_caption: finalCaption,
                    full_palette_15: punk.fullPalette15,
                    region_analysis: punk.regionAnalysis,
                    detected_traits: punk.detectedTraits,
                    updated_at: new Date().toISOString()
                })
                .eq('filename', punk.filename);

            if (error) {
                console.error('Save error:', error);
                alert('Failed to save: ' + error.message);
                setStatus('disconnected', 'Save failed');
                return;
            }

            punk.status = 'edited';
            punk.userInput = userCorrections;
            punk.userCorrections = userCorrections;
            punk.finalCaption = finalCaption;
            punk.userApproved = true;
            stats.edited++;
            stats.pending--;

            setStatus('connected', 'Connected to cloud');
            showSaveIndicator('‚òÅÔ∏è Edited & synced');
            next();
        }

        function mergeCaptions(aiCaption, userCorrections, punk) {
            // Start with AI caption as base
            let finalParts = aiCaption.split(', ');

            // Parse user corrections (they can say things like "brown eyes not blue", "afro hair", etc.)
            const corrections = userCorrections.toLowerCase();

            // Apply corrections by replacing specific traits
            if (corrections.includes('brown eyes')) {
                finalParts = finalParts.filter(p => !p.includes('eyes'));
                finalParts.push('brown eyes');
            }
            if (corrections.includes('blue eyes')) {
                finalParts = finalParts.filter(p => !p.includes('eyes'));
                finalParts.push('blue eyes');
            }
            if (corrections.includes('green eyes')) {
                finalParts = finalParts.filter(p => !p.includes('eyes'));
                finalParts.push('green eyes');
            }
            if (corrections.includes('afro')) {
                finalParts = finalParts.filter(p => !p.includes('hair'));
                finalParts.push(corrections.match(/([\w\s]+afro[\w\s]+hair)/i)?.[0] || 'afro hair');
            }

            // If user just added notes, append them
            if (!corrections.includes(' not ') && !corrections.includes('instead')) {
                // User is adding details, not replacing
                finalParts.push(userCorrections);
            }

            return finalParts.join(', ');
        }

        async function skip() {
            const punk = data[currentIndex];

            setStatus('syncing', 'Saving to cloud...');

            const { error } = await supabase
                .from('caption_reviews')
                .update({
                    status: 'skipped',
                    updated_at: new Date().toISOString()
                })
                .eq('filename', punk.filename);

            if (error) {
                console.error('Save error:', error);
                setStatus('disconnected', 'Save failed');
                return;
            }

            punk.status = 'skipped';
            stats.skipped++;
            stats.pending--;

            setStatus('connected', 'Connected to cloud');
            showSaveIndicator('‚òÅÔ∏è Skipped & synced');
            next();
        }

        function prev() {
            if (currentIndex > 0) {
                loadPunk(currentIndex - 1);
            }
        }

        function next() {
            if (currentIndex < data.length - 1) {
                loadPunk(currentIndex + 1);
            } else {
                alert('üéâ ALL DONE! All data is saved in Supabase.');
            }
        }

        function showSaveIndicator(text) {
            const indicator = document.getElementById('save-indicator');
            indicator.textContent = text;
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 1500);
        }

        function updateProgress() {
            const total = data.length;
            const completed = stats.approved + stats.edited;
            const remaining = stats.pending;
            const percent = (completed / total) * 100;

            document.getElementById('progress').style.width = percent + '%';
            document.getElementById('current').textContent = currentIndex + 1;
            document.getElementById('total').textContent = total;
            document.getElementById('percent').textContent = Math.round(percent);
            document.getElementById('approved').textContent = stats.approved;
            document.getElementById('edited').textContent = stats.edited;
            document.getElementById('skipped').textContent = stats.skipped;
            document.getElementById('remaining').textContent = remaining;
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'TEXTAREA') return;

            if (e.key === 'a' || e.key === 'A') approve();
            if (e.key === 'e' || e.key === 'E') saveEdit();
            if (e.key === 's' || e.key === 'S') skip();
            if (e.key === 'ArrowLeft') prev();
        });

        // Start the app
        init();
    </script>
</body>
</html>
