<!DOCTYPE html>
<html>
<head>
    <title>FAST Caption Review - Recovery Mode</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Monaco', monospace; background: #0a0a0a; color: #e0e0e0; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; }

        .header { text-align: center; margin-bottom: 15px; padding: 15px; background: #1a1a1a; border-radius: 8px; }
        h1 { color: #00ff88; font-size: 24px; }
        .subtitle { color: #888; font-size: 12px; margin-top: 5px; }
        .backup-btn { margin-top: 10px; padding: 12px 25px; background: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .backup-btn:hover { background: #ff5252; }

        .progress { background: #1a1a1a; padding: 12px; border-radius: 8px; margin-bottom: 15px; }
        .progress-bar { width: 100%; height: 20px; background: #0a0a0a; border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #00ff88, #00cc66); transition: width 0.3s; }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
        .stat { background: #0a0a0a; padding: 8px; border-radius: 4px; text-align: center; }
        .stat-num { font-size: 18px; color: #00ff88; font-weight: bold; }
        .stat-label { font-size: 9px; color: #666; margin-top: 3px; }

        .main { display: grid; grid-template-columns: 400px 1fr; gap: 15px; }

        .image-panel { background: #1a1a1a; padding: 15px; border-radius: 8px; }
        .punk-img { width: 370px; height: 370px; image-rendering: pixelated; border: 3px solid #333; }
        .filename { margin-top: 10px; color: #00ff88; font-weight: bold; text-align: center; font-size: 13px; }

        .shortcuts { margin-top: 15px; background: #0a0a0a; padding: 12px; border-radius: 4px; }
        .shortcuts-title { color: #00ff88; font-size: 11px; font-weight: bold; margin-bottom: 8px; }
        .shortcut { font-size: 10px; color: #888; margin: 4px 0; }
        .key { color: #00ff88; font-weight: bold; }

        .review-panel { background: #1a1a1a; padding: 15px; border-radius: 8px; }

        .caption-row { display: grid; grid-template-columns: 80px 1fr; gap: 10px; margin-bottom: 10px; align-items: start; }
        .caption-label { color: #00ff88; font-size: 11px; font-weight: bold; padding-top: 8px; }
        .caption-text { background: #0a0a0a; padding: 10px; border-radius: 4px; font-size: 11px; line-height: 1.5; color: #888; border: 2px solid #2a2a2a; }
        .ai-caption { color: #51cf66; }

        .diff-highlight { background: #2a2a2a; padding: 10px; border-radius: 4px; margin: 10px 0; font-size: 10px; }
        .same { color: #51cf66; }
        .different { color: #ff6b6b; }

        .input-box { width: 100%; min-height: 100px; background: #0a0a0a; border: 3px solid #2a2a2a; color: #e0e0e0; padding: 12px; font-size: 13px; border-radius: 4px; font-family: inherit; resize: vertical; }
        .input-box:focus { border-color: #00ff88; outline: none; }

        .quick-fixes { margin: 10px 0; }
        .quick-fix-btn { padding: 6px 12px; margin: 3px; background: #2a2a2a; color: #e0e0e0; border: none; border-radius: 4px; cursor: pointer; font-size: 10px; }
        .quick-fix-btn:hover { background: #3a3a3a; }

        .action-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px; }
        button { padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; font-family: inherit; transition: all 0.2s; }
        .btn-prev { background: #2a2a2a; color: #e0e0e0; }
        .btn-prev:hover { background: #3a3a3a; }
        .btn-approve { background: #00ff88; color: #000; }
        .btn-approve:hover { background: #00cc66; }
        .btn-save { background: #4a9eff; color: #fff; }
        .btn-save:hover { background: #3a8eef; }
        .btn-skip { background: #444; color: #e0e0e0; }
        .btn-skip:hover { background: #555; }

        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #00ff88;
            color: #000;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 1000;
        }
        .save-indicator.show { opacity: 1; }
    </style>
</head>
<body>
    <div class="save-indicator" id="save-indicator">‚úì Saved!</div>
    <div class="container">
        <div class="header">
            <h1>‚ö° FAST Caption Review - Recovery Mode</h1>
            <p class="subtitle">AUTO-SAVES EVERY ACTION | Press A to approve, E to edit, S to skip</p>
            <button class="backup-btn" onclick="manualDownload()">üíæ DOWNLOAD BACKUP NOW (every 20 entries!)</button>
        </div>

        <div class="progress">
            <div><strong id="current">1</strong> / <strong id="total">203</strong> ¬∑ <span id="percent">0%</span> complete</div>
            <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
            <div class="stats">
                <div class="stat"><div class="stat-num" id="approved">0</div><div class="stat-label">Approved</div></div>
                <div class="stat"><div class="stat-num" id="edited">0</div><div class="stat-label">Edited</div></div>
                <div class="stat"><div class="stat-num" id="skipped">0</div><div class="stat-label">Skipped</div></div>
                <div class="stat"><div class="stat-num" id="remaining">203</div><div class="stat-label">Remaining</div></div>
            </div>
        </div>

        <div class="main">
            <div class="image-panel">
                <img id="punk-img" class="punk-img" src="" alt="Punk">
                <div class="filename" id="filename"></div>

                <div class="shortcuts">
                    <div class="shortcuts-title">‚ö° Keyboard Shortcuts</div>
                    <div class="shortcut"><span class="key">A</span> - Approve AI caption (if perfect)</div>
                    <div class="shortcut"><span class="key">E</span> - Edit & save current input</div>
                    <div class="shortcut"><span class="key">S</span> - Skip this one</div>
                    <div class="shortcut"><span class="key">‚Üê</span> - Go back</div>
                    <div class="shortcut"><span class="key">Cmd+Enter</span> - Save & next</div>
                </div>
            </div>

            <div class="review-panel">
                <div class="caption-row">
                    <div class="caption-label">CURRENT:</div>
                    <div class="caption-text" id="current-caption"></div>
                </div>

                <div class="caption-row">
                    <div class="caption-label ai-caption">AI NEW:</div>
                    <div class="caption-text ai-caption" id="ai-caption"></div>
                </div>

                <div id="diff" class="diff-highlight"></div>

                <div style="margin-top: 15px;">
                    <label style="color: #00ff88; font-size: 12px; font-weight: bold; display: block; margin-bottom: 8px;">Your Corrections:</label>
                    <textarea id="user-input" class="input-box" placeholder="Type corrections here, or press A to approve AI, or press S to skip..."></textarea>
                </div>

                <div class="quick-fixes">
                    <button class="quick-fix-btn" onclick="addFix('brown eyes not blue')">Brown eyes</button>
                    <button class="quick-fix-btn" onclick="addFix('blue eyes not gray')">Blue eyes</button>
                    <button class="quick-fix-btn" onclick="addFix('green eyes')">Green eyes</button>
                    <button class="quick-fix-btn" onclick="addFix('afro hair')">Afro hair</button>
                    <button class="quick-fix-btn" onclick="addFix('long hair')">Long hair</button>
                    <button class="quick-fix-btn" onclick="addFix('short hair')">Short hair</button>
                </div>

                <div class="action-buttons">
                    <button class="btn-prev" onclick="prev()">‚Üê Back</button>
                    <button class="btn-approve" onclick="approve()">‚úì Approve AI (A)</button>
                    <button class="btn-save" onclick="saveEdit()">Save Edit (E)</button>
                    <button class="btn-skip" onclick="skip()">Skip (S)</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let data = [];
        let currentIndex = 0;
        let results = { approved: [], edited: [], skipped: [] };

        // RESTORE FROM LOCALSTORAGE
        console.log('üîç CHECKING LOCALSTORAGE ON LOAD...');
        const savedData = localStorage.getItem('fast_review_data');
        const savedResults = localStorage.getItem('fast_review_results');
        const savedIndex = localStorage.getItem('fast_review_index');

        console.log('  - fast_review_data:', savedData ? (savedData.length + ' bytes') : 'NOT FOUND');
        console.log('  - fast_review_results:', savedResults ? (savedResults.length + ' bytes') : 'NOT FOUND');
        console.log('  - fast_review_index:', savedIndex || 'NOT FOUND');

        if (savedData && savedResults) {
            console.log('üîÑ RESTORING FROM BACKUP...');
            try {
                data = JSON.parse(savedData);
                results = JSON.parse(savedResults);
                currentIndex = savedIndex ? parseInt(savedIndex) : 0;

                console.log('‚úì RESTORED:');
                console.log('  - Data items:', data.length);
                console.log('  - Approved:', results.approved.length);
                console.log('  - Edited:', results.edited.length);
                console.log('  - Skipped:', results.skipped.length);
                console.log('  - Current index:', currentIndex);

                loadPunk(currentIndex);
                alert(`‚úì RESTORED! ${results.approved.length + results.edited.length} completed`);
            } catch(e) {
                console.error('‚úó RESTORE ERROR:', e);
                alert('Error restoring backup: ' + e.message);
            }
        } else {
            console.log('‚ÑπÔ∏è No backup found, loading fresh data...');
            fetch('comprehensive_captions_for_review.json')
                .then(r => r.json())
                .then(d => {
                    data = d;
                    console.log('‚úì Loaded fresh data:', data.length, 'items');
                    loadPunk(0);
                })
                .catch(err => {
                    console.error('‚úó FETCH ERROR:', err);
                    alert('Error: ' + err.message);
                });
        }

        function saveToLocalStorage() {
            try {
                const dataStr = JSON.stringify(data);
                const resultsStr = JSON.stringify(results);

                localStorage.setItem('fast_review_data', dataStr);
                localStorage.setItem('fast_review_results', resultsStr);
                localStorage.setItem('fast_review_index', currentIndex.toString());

                console.log('üíæ SAVED TO LOCALSTORAGE:');
                console.log('  - Data size:', dataStr.length, 'bytes');
                console.log('  - Results:', results.approved.length, 'approved,', results.edited.length, 'edited');
                console.log('  - Index:', currentIndex);
                console.log('  - localStorage check:', localStorage.getItem('fast_review_index'));

                // Verify it was saved
                const verify = localStorage.getItem('fast_review_results');
                if (verify) {
                    console.log('‚úì VERIFIED: Data is in localStorage');
                } else {
                    console.error('‚úó ERROR: Data NOT in localStorage after save!');
                }
            } catch(e) {
                console.error('‚úó SAVE ERROR:', e);
                alert('ERROR saving to localStorage: ' + e.message);
            }
        }

        function autoSaveInput() {
            if (currentIndex >= 0 && currentIndex < data.length) {
                const input = document.getElementById('user-input').value.trim();
                data[currentIndex].userInput = input;
                console.log(`üìù Auto-save input for ${data[currentIndex].filename}: "${input || '(empty)'}"`);
                saveToLocalStorage();
            }
        }

        function loadPunk(index) {
            if (index < 0 || index >= data.length) return;

            autoSaveInput();
            currentIndex = index;
            const punk = data[index];

            document.getElementById('punk-img').src = 'civitai_v2_7_training/' + punk.filename;
            document.getElementById('filename').textContent = punk.filename;
            document.getElementById('current-caption').textContent = punk.currentCaption || 'None';
            document.getElementById('ai-caption').textContent = punk.aiComprehensiveCaption || 'None';
            document.getElementById('user-input').value = punk.userInput || '';

            // Show diff
            if (punk.currentCaption === punk.aiComprehensiveCaption) {
                document.getElementById('diff').innerHTML = '<span class="same">‚úì AI matches current</span>';
            } else {
                document.getElementById('diff').innerHTML = '<span class="different">‚ö† Captions differ - review needed</span>';
            }

            updateProgress();
        }

        function approve() {
            const punk = data[currentIndex];
            punk.userApproved = true;
            punk.finalCaption = punk.aiComprehensiveCaption;
            punk.timestamp = new Date().toISOString();
            results.approved.push(punk);

            saveToLocalStorage();
            showSaveIndicator('approved');
            next();
        }

        function saveEdit() {
            const punk = data[currentIndex];
            const edited = document.getElementById('user-input').value.trim();

            if (!edited) {
                alert('Type a correction first, or press A to approve AI!');
                return;
            }

            punk.userInput = edited;
            punk.userApproved = true;
            punk.timestamp = new Date().toISOString();
            results.edited.push(punk);

            saveToLocalStorage();
            showSaveIndicator('edited');
            next();
        }

        function skip() {
            results.skipped.push(data[currentIndex]);
            saveToLocalStorage();
            showSaveIndicator('skipped');
            next();
        }

        function prev() {
            if (currentIndex > 0) loadPunk(currentIndex - 1);
        }

        function next() {
            if (currentIndex < data.length - 1) {
                loadPunk(currentIndex + 1);
            } else {
                alert('üéâ DONE! Downloading final results...');
                download();
            }
        }

        function addFix(text) {
            const input = document.getElementById('user-input');
            if (input.value) input.value += ', ';
            input.value += text;
            input.focus();
            autoSaveInput();
        }

        function showSaveIndicator(action) {
            const indicator = document.getElementById('save-indicator');
            const total = results.approved.length + results.edited.length + results.skipped.length;
            indicator.textContent = `‚úì ${action} (${total} total)`;
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 1000);
        }

        function updateProgress() {
            const total = results.approved.length + results.edited.length + results.skipped.length;
            const remaining = data.length - total;
            const percent = (total / data.length) * 100;

            document.getElementById('progress').style.width = percent + '%';
            document.getElementById('current').textContent = currentIndex + 1;
            document.getElementById('total').textContent = data.length;
            document.getElementById('percent').textContent = Math.round(percent);
            document.getElementById('approved').textContent = results.approved.length;
            document.getElementById('edited').textContent = results.edited.length;
            document.getElementById('skipped').textContent = results.skipped.length;
            document.getElementById('remaining').textContent = remaining;

            // Auto-backup every 20 entries
            if (total > 0 && total % 20 === 0) {
                manualDownload();
            }
        }

        function manualDownload() {
            const output = {
                approved: results.approved,
                edited: results.edited,
                skipped: results.skipped,
                summary: {
                    total: data.length,
                    approved: results.approved.length,
                    edited: results.edited.length,
                    skipped: results.skipped.length,
                    timestamp: new Date().toISOString()
                }
            };

            const blob = new Blob([JSON.stringify(output, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `FAST_REVIEW_BACKUP_${Date.now()}.json`;
            a.click();

            alert(`‚úì Backup downloaded! ${results.approved.length + results.edited.length} entries saved.`);
        }

        function download() {
            manualDownload();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'TEXTAREA') {
                if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
                    saveEdit();
                }
                return;
            }

            if (e.key === 'a' || e.key === 'A') approve();
            if (e.key === 'e' || e.key === 'E') saveEdit();
            if (e.key === 's' || e.key === 'S') skip();
            if (e.key === 'ArrowLeft') prev();
        });

        // Auto-save on typing
        let timeout;
        document.getElementById('user-input').addEventListener('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(autoSaveInput, 500);
        });

        // Save before close
        window.addEventListener('beforeunload', autoSaveInput);
    </script>
</body>
</html>
