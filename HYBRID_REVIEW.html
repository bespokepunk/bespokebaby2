<!DOCTYPE html>
<html>
<head>
    <title>Hybrid Caption Review</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Monaco', monospace; background: #0a0a0a; color: #e0e0e0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }

        .header { text-align: center; margin-bottom: 20px; padding: 20px; background: #1a1a1a; border-radius: 8px; }
        h1 { color: #00ff88; font-size: 28px; }
        .subtitle { color: #888; font-size: 14px; margin-top: 5px; }

        .progress { background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .progress-text { font-size: 16px; margin-bottom: 10px; }
        .progress-bar { width: 100%; height: 25px; background: #0a0a0a; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #00ff88, #00cc66); transition: width 0.3s; }

        .main { display: grid; grid-template-columns: 500px 1fr; gap: 20px; }

        .image-section { background: #1a1a1a; padding: 20px; border-radius: 8px; }
        .punk-img { width: 460px; height: 460px; image-rendering: pixelated; border: 3px solid #333; }
        .filename { margin-top: 15px; color: #00ff88; font-weight: bold; font-size: 16px; text-align: center; }

        .input-section { background: #1a1a1a; padding: 20px; border-radius: 8px; }

        .caption-box { background: #0a0a0a; padding: 15px; border-radius: 4px; border: 2px solid #2a2a2a; margin-bottom: 15px; }
        .caption-label { color: #00ff88; font-weight: bold; font-size: 12px; margin-bottom: 8px; display: block; }
        .caption-text { color: #888; font-size: 12px; line-height: 1.6; }
        .ai-caption { color: #51cf66; }

        .label { color: #00ff88; font-weight: bold; font-size: 14px; margin: 15px 0 10px 0; display: block; }
        .input-box { width: 100%; min-height: 120px; background: #0a0a0a; border: 3px solid #2a2a2a; color: #e0e0e0; padding: 15px; font-size: 14px; border-radius: 4px; font-family: inherit; resize: vertical; }
        .input-box:focus { border-color: #00ff88; outline: none; }
        .input-box::placeholder { color: #444; }

        .help-text { font-size: 11px; color: #666; margin-top: 5px; }
        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #00ff88;
            color: #000;
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 1000;
        }
        .save-indicator.show { opacity: 1; }

        .buttons { display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 10px; margin-top: 20px; }
        button { padding: 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px; font-family: inherit; transition: all 0.2s; }
        .btn-prev { background: #2a2a2a; color: #e0e0e0; }
        .btn-prev:hover { background: #3a3a3a; }
        .btn-skip { background: #444; color: #e0e0e0; }
        .btn-skip:hover { background: #555; }
        .btn-save { background: #00ff88; color: #000; }
        .btn-save:hover { background: #00cc66; }

        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .stat { background: #0a0a0a; padding: 10px; border-radius: 4px; text-align: center; }
        .stat-num { font-size: 24px; color: #00ff88; font-weight: bold; }
        .stat-label { font-size: 11px; color: #666; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="save-indicator" id="save-indicator">‚úì Saved!</div>
    <div class="container">
        <div class="header">
            <h1>üé® Hybrid Caption Review</h1>
            <p class="subtitle">Review current & AI captions, add your corrections/gaps</p>
            <button onclick="manualDownload()" style="margin-top: 10px; padding: 10px 20px; background: #4a9eff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">üíæ Download Progress Now</button>
        </div>

        <div class="progress">
            <div class="progress-text"><strong id="current">1</strong> / <strong id="total">203</strong></div>
            <div class="progress-bar"><div class="progress-fill" id="progress" style="width: 0%"></div></div>
            <div class="stats">
                <div class="stat"><div class="stat-num" id="completed">0</div><div class="stat-label">Completed</div></div>
                <div class="stat"><div class="stat-num" id="skipped">0</div><div class="stat-label">Skipped</div></div>
                <div class="stat"><div class="stat-num" id="remaining">203</div><div class="stat-label">Remaining</div></div>
            </div>
        </div>

        <div class="main">
            <div class="image-section">
                <img id="punk-img" class="punk-img" src="" alt="Punk">
                <div class="filename" id="filename"></div>
            </div>

            <div class="input-section">
                <div class="caption-box">
                    <span class="caption-label">Current Caption (Original):</span>
                    <div class="caption-text" id="current-caption"></div>
                </div>

                <div class="caption-box">
                    <span class="caption-label ai-caption">AI Comprehensive Caption:</span>
                    <div class="caption-text ai-caption" id="ai-caption"></div>
                </div>

                <label class="label">Your Corrections / Missing Details:</label>
                <textarea
                    id="user-input"
                    class="input-box"
                    placeholder="Add any corrections or missing details:

Examples:
- Eyes should be brown not blue
- Hair is afro style not fluffy
- Wearing gold earrings
- Background should be #a8d5ba

Leave blank if both captions look perfect!"
                    autofocus
                ></textarea>
                <div class="help-text">Cmd/Ctrl+Enter to save & next</div>

                <div class="buttons">
                    <button class="btn-prev" onclick="prev()">‚Üê Back</button>
                    <button class="btn-skip" onclick="skip()">Skip</button>
                    <button class="btn-save" onclick="save()">Save & Next ‚Üí</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let data = [];
        let currentIndex = 0;
        let results = { completed: [], skipped: [] };

        // Try to restore from localStorage first
        const savedData = localStorage.getItem('hybrid_review_data');
        const savedResults = localStorage.getItem('hybrid_review_results');
        const savedIndex = localStorage.getItem('hybrid_review_index');

        if (savedData && savedResults) {
            console.log('üîÑ RESTORING from localStorage...');
            data = JSON.parse(savedData);
            results = JSON.parse(savedResults);
            currentIndex = savedIndex ? parseInt(savedIndex) : 0;
            loadPunk(currentIndex);
            alert(`‚úì Restored your progress! ${results.completed.length} completed, ${results.skipped.length} skipped`);
        } else {
            fetch('comprehensive_captions_for_review.json')
                .then(r => r.json())
                .then(d => {
                    data = d;
                    loadPunk(0);
                })
                .catch(err => {
                    alert('Error loading data: ' + err.message);
                    console.error(err);
                });
        }

        function saveToLocalStorage() {
            localStorage.setItem('hybrid_review_data', JSON.stringify(data));
            localStorage.setItem('hybrid_review_results', JSON.stringify(results));
            localStorage.setItem('hybrid_review_index', currentIndex.toString());
        }

        function autoSaveCurrentInput() {
            // Auto-save whatever is typed in the current input box
            if (currentIndex >= 0 && currentIndex < data.length) {
                const userInput = document.getElementById('user-input').value.trim();
                data[currentIndex].userInput = userInput;
                console.log('Auto-saved input for:', data[currentIndex].filename, ':', userInput || '(empty)');
                saveToLocalStorage();
            }
        }

        function loadPunk(index) {
            if (index < 0 || index >= data.length) return;

            // Auto-save current input before navigating away
            autoSaveCurrentInput();

            currentIndex = index;
            const punk = data[index];

            // Fix image path - use relative path from current location
            const imgPath = 'civitai_v2_7_training/' + punk.filename;
            console.log('Loading image:', imgPath);
            document.getElementById('punk-img').src = imgPath;

            document.getElementById('filename').textContent = punk.filename;
            document.getElementById('current-caption').textContent = punk.currentCaption || 'No current caption';
            document.getElementById('ai-caption').textContent = punk.aiComprehensiveCaption || 'No AI caption';

            // Restore any previously entered input
            document.getElementById('user-input').value = punk.userInput || '';
            document.getElementById('user-input').focus();

            console.log('Loaded punk:', punk.filename, '- Has user input:', !!punk.userInput);

            updateProgress();
        }

        function save() {
            const punk = data[currentIndex];
            const userInput = document.getElementById('user-input').value.trim();

            // Save even if empty - means user approved both captions
            punk.userInput = userInput;
            punk.userApproved = true;
            punk.timestamp = new Date().toISOString();

            results.completed.push(punk);

            // Save to localStorage
            saveToLocalStorage();

            // Show save indicator
            const indicator = document.getElementById('save-indicator');
            indicator.textContent = `‚úì Saved ${punk.filename} (${results.completed.length} total)`;
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 1500);

            // Debug logging
            console.log('‚úì SAVED:', punk.filename);
            console.log('  User input:', userInput || '(approved as-is)');
            console.log('  Total saved:', results.completed.length);
            console.log('  Results object:', results);

            next();
        }

        function skip() {
            results.skipped.push(data[currentIndex]);
            saveToLocalStorage();
            next();
        }

        function manualDownload() {
            autoSaveCurrentInput();
            download();
        }

        function prev() {
            if (currentIndex > 0) {
                loadPunk(currentIndex - 1);
            }
        }

        function next() {
            if (currentIndex < data.length - 1) {
                loadPunk(currentIndex + 1);
            } else {
                alert('üéâ All done! Downloading your review...');
                download();
            }
        }

        function updateProgress() {
            const totalReviewed = results.completed.length + results.skipped.length;
            const remaining = data.length - totalReviewed;
            const percent = (totalReviewed / data.length) * 100;

            document.getElementById('progress').style.width = percent + '%';
            document.getElementById('current').textContent = currentIndex + 1;
            document.getElementById('total').textContent = data.length;
            document.getElementById('completed').textContent = results.completed.length;
            document.getElementById('skipped').textContent = results.skipped.length;
            document.getElementById('remaining').textContent = remaining;
        }

        function download() {
            const output = {
                completed: results.completed,
                skipped: results.skipped,
                summary: {
                    total: data.length,
                    completed: results.completed.length,
                    skipped: results.skipped.length,
                    timestamp: new Date().toISOString()
                }
            };

            const blob = new Blob([JSON.stringify(output, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'HYBRID_REVIEW_RESULTS.json';
            a.click();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.id === 'user-input') {
                if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
                    save();
                }
                return;
            }

            if (e.key === 'ArrowLeft') prev();
            if (e.key === 's' || e.key === 'S') skip();
        });

        // Auto-save on input changes (debounced)
        let autoSaveTimeout;
        document.getElementById('user-input').addEventListener('input', () => {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                autoSaveCurrentInput();
            }, 500); // Auto-save 500ms after user stops typing
        });

        // Auto-save when leaving the page
        window.addEventListener('beforeunload', () => {
            autoSaveCurrentInput();
        });

        // Debug image loading
        document.getElementById('punk-img').onerror = function() {
            console.error('Failed to load image:', this.src);
            this.style.border = '3px solid red';
        };
    </script>
</body>
</html>
